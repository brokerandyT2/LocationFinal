<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
            xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
            xmlns:maui="clr-namespace:epj.Expander.Maui;assembly=epj.Expander.Maui"
            xmlns:viewmodels="clr-namespace:Location.Photography.ViewModels;assembly=Location.Photography.ViewModels"
            xmlns:domain="clr-namespace:Location.Photography.ViewModels;assembly=Location.Photography.ViewModels"
            x:Class="Location.Photography.Maui.Views.Professional.AstroPhotographyCalculator"
            x:DataType="viewmodels:AstroPhotographyCalculatorViewModel"
            Title="Astrophotography Calculator">

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Ensure we have the string to bool converter -->
            <x:String x:Key="StringToBoolConverter">StringToBoolConverter</x:String>
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid Padding="10" Margin="5">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Main Content -->
        <ScrollView Grid.Row="0">
            <StackLayout Spacing="15">

                <!-- Location and Date Selection -->
                <Frame BackgroundColor="#F8F9FA" HasShadow="True" CornerRadius="10" Padding="15">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="200"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Label Grid.Row="0" Text="Location &amp; Date" FontSize="18" FontAttributes="Bold" Margin="0,0,0,10"/>

                        <!-- Location Image -->
                        <Image Grid.Row="1" Source="{Binding LocationPhoto}" 
                              HeightRequest="200" Aspect="AspectFill"/>

                        <!-- Location Picker -->
                        <Grid Grid.Row="2" Margin="0,10,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Label Grid.Row="0" Text="Choose your location" FontSize="14"/>
                            <Picker Grid.Row="1" ItemsSource="{Binding Locations, Mode=TwoWay}" 
                                   SelectedItem="{Binding SelectedLocation}"
                                   ItemDisplayBinding="{Binding Title}" x:Name="LocationPicker"
                                   FontSize="14" Margin="0,5,0,0"/>
                        </Grid>

                        <!-- Date Picker -->
                        <Grid Grid.Row="3" Margin="0,10,0,0">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            <Label Grid.Row="0" Text="Choose observation date" FontSize="14"/>
                            <DatePicker Grid.Row="1" Date="{Binding SelectedDate}"
                                       DateSelected="OnDateSelectionChanged"
                                       FontSize="14" Margin="0,5,0,0"/>
                        </Grid>
                    </Grid>
                </Frame>

                <!-- Equipment Selection -->
                                <!-- Astrophotography Target Selection -->
                

                <!-- Field of View Information -->
                <Frame BackgroundColor="#FFF3E0" HasShadow="True" CornerRadius="10" Padding="15" 
                      IsVisible="{Binding HasEquipmentSelected}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <Label Grid.Row="0" Text="Field of View Analysis" FontSize="16" FontAttributes="Bold" TextColor="#F57C00"/>

                        <Grid Grid.Row="1" Margin="0,10,0,0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            <StackLayout Grid.Column="0">
                                <Label Text="Field of View" FontSize="12" TextColor="Gray"/>
                                <Label Text="{Binding FieldOfViewDisplay}" FontSize="14" FontAttributes="Bold"/>
                            </StackLayout>
                            <StackLayout Grid.Column="1">
                                <Label Text="Target Coverage" FontSize="12" TextColor="Gray"/>
                                <Label Text="{Binding TargetFitsInFrame, Converter={StaticResource BoolToTextConverter}}" 
                                      FontSize="14" FontAttributes="Bold"/>
                            </StackLayout>
                        </Grid>

                        <Label Grid.Row="2" Text="{Binding EquipmentRecommendation}" 
                              FontSize="12" TextColor="#FF9800" Margin="0,10,0,0"/>
                    </Grid>
                </Frame>

                <!-- Calculate Button 
                <Button Text="Calculate Astrophotography Data" 
                       Command="{Binding CalculateAstroDataCommand}"
                       
                       BackgroundColor="#4CAF50" TextColor="White"
                       FontSize="16" FontAttributes="Bold"
                       HeightRequest="50" CornerRadius="10"/>
-->
               

                  <!-- Calculation Results with Loading Overlay -->
                <Frame BackgroundColor="#F9FBE7" HasShadow="True" CornerRadius="10" Padding="15" HeightRequest="400"
                      IsVisible="{Binding CurrentCalculations, Converter={StaticResource CollectionToBoolConverter}}">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <Label Grid.Row="0" Text="Astronomical Calculations" FontSize="16" FontAttributes="Bold" TextColor="#689F38" Margin="0,0,0,10"/>

                        <Grid Grid.Row="1">
                            <CollectionView ItemsSource="{Binding HourlyAstroPredictions}">
                                <CollectionView.ItemTemplate>
                                    <DataTemplate x:DataType="domain:AstroHourlyPredictionDisplayModel">
                                        <maui:Expander Animated="True" Margin="0,2,0,2">
                                            <maui:Expander.HeaderContent>
                                                <Grid BackgroundColor="#E8F5E8" Padding="15">
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                        <ColumnDefinition Width="60"/>
                                                    </Grid.ColumnDefinitions>

                                                    <StackLayout Grid.Column="0" VerticalOptions="Center">
                                                        <Label Text="{Binding TimeDisplay}" 
                                  FontSize="16" 
                                  FontAttributes="Bold"/>
                                                        <Label Text="{Binding SolarEventsDisplay}" 
                                  FontSize="12" 
                                  TextColor="Gray"/>
                                                    </StackLayout>

                                                    <StackLayout Grid.Column="1" VerticalOptions="Center">
                                                        <Label Text="{Binding QualityDisplay}" 
                                  FontSize="12" 
                                  FontAttributes="Bold"/>
                                                        <Label Text="{Binding QualityScore, StringFormat='Score: {0:F0}'}" 
                                  FontSize="10" 
                                  TextColor="Gray"/>
                                                    </StackLayout>

                                                    <!-- Quality Indicator -->
                                                    <StackLayout Grid.Column="2" VerticalOptions="Center" HorizontalOptions="Center">
                                                        <Label Text="{Binding IsOptimalTime, Converter={StaticResource BoolToSymbolConverter}}" 
                                  FontSize="24" 
                                  HorizontalTextAlignment="Center"/>
                                                    </StackLayout>
                                                </Grid>
                                            </maui:Expander.HeaderContent>

                                            <!-- Enhanced Expanded Content -->
                                            <Grid Padding="15" BackgroundColor="White">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>

                                                <!-- Quality Information -->
                                                <StackLayout Grid.Row="0" Margin="0,0,0,10">
                                                    <Label Text="Conditions Assessment" 
                              FontSize="14" 
                              FontAttributes="Bold" 
                              TextColor="#2E7D32"/>
                                                    <Label Text="{Binding QualityDescription}" 
                              FontSize="12" 
                              TextColor="#666666"/>
                                                    <Label Text="{Binding ConfidenceDisplay}" 
                              FontSize="10" 
                              TextColor="Gray"/>
                                                </StackLayout>

                                                <!-- Astro Events -->
                                                <!-- Astro Events -->
                                                <StackLayout Grid.Row="1" Margin="0,0,0,10" IsVisible="{Binding AstroEvents, Converter={StaticResource IsNotNullConverter}}">
                                                    <Label Text="Astrophotography Targets" 
          FontSize="14" 
          FontAttributes="Bold" 
          TextColor="#FF9800"/>
                                                    <CollectionView ItemsSource="{Binding AstroEvents}" HeightRequest="120">
                                                        <CollectionView.ItemTemplate>
                                                            <DataTemplate x:DataType="domain:AstroEventDisplayModel">
                                                                <Grid Padding="5" Margin="0,2">
                                                                    <Grid.RowDefinitions>
                                                                        <RowDefinition Height="Auto"/>
                                                                        <RowDefinition Height="Auto"/>
                                                                        <RowDefinition Height="Auto"/>
                                                                    </Grid.RowDefinitions>

                                                                    <Label Grid.Row="0" Text="{Binding TargetName}" 
                          FontSize="13" FontAttributes="Bold"/>
                                                                    <Label Grid.Row="1" Text="{Binding Visibility}" 
                          FontSize="11" TextColor="Gray"/>
                                                                    <Label Grid.Row="2" Text="{Binding Notes}" 
                          FontSize="10" TextColor="#666666"/>
                                                                </Grid>
                                                            </DataTemplate>
                                                        </CollectionView.ItemTemplate>
                                                    </CollectionView>
                                                </StackLayout>

                                                <!-- Weather Information -->
                                                <StackLayout Grid.Row="2" Margin="0,0,0,10">
                                                    <Label Text="Weather Conditions" 
                              FontSize="14" 
                              FontAttributes="Bold" 
                              TextColor="#1976D2"/>
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="*"/>
                                                        </Grid.ColumnDefinitions>
                                                        <StackLayout Grid.Column="0">
                                                            <Label Text="{Binding WeatherCloudCover, StringFormat='Clouds: {0:F0}%'}" 
                                      FontSize="11"/>
                                                            <Label Text="{Binding WeatherWindSpeed, StringFormat='Wind: {0:F0} mph'}" 
                                      FontSize="11"/>
                                                        </StackLayout>
                                                        <StackLayout Grid.Column="1">
                                                            <Label Text="{Binding WeatherHumidity, StringFormat='Humidity: {0:F0}%'}" 
                                      FontSize="11"/>
                                                            <Label Text="{Binding WeatherDescription}" 
                                      FontSize="11"/>
                                                        </StackLayout>
                                                    </Grid>
                                                </StackLayout>

                                                <!-- Recommendations -->
                                                <StackLayout Grid.Row="3">
                                                    <Label Text="Recommendations" 
                              FontSize="14" 
                              FontAttributes="Bold" 
                              TextColor="#9C27B0"/>
                                                    <Label Text="{Binding Recommendations}" 
                              FontSize="11" 
                              TextColor="#666666"/>
                                                </StackLayout>
                                            </Grid>
                                        </maui:Expander>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </Grid>
                    </Grid>
                </Frame>

                <!-- Refresh Button 
                <Button Text="Refresh Calculations" 
                       Command="{Binding RefreshCalculationsCommand}"
                       IsEnabled="{Binding HasValidSelection}"
                       BackgroundColor="#FF9800" TextColor="White"
                       FontSize="14" FontAttributes="Bold"
                       HeightRequest="40" CornerRadius="8"
                       IsVisible="{Binding CurrentCalculations, Converter={StaticResource CollectionToBoolConverter}}"/>-->

            </StackLayout>
        </ScrollView>

        <!-- Error message display (keep global for errors) -->
        <Grid Grid.Row="0" 
             IsVisible="{Binding HasError}"
             BackgroundColor="#FFCDD2"
             Padding="15"
             Margin="5"
             VerticalOptions="End">
            <StackLayout Orientation="Horizontal" Spacing="10">
                <Label Text="⚠️" FontSize="16" VerticalOptions="Center"/>
                <Label Text="{Binding ErrorMessage}"
                      TextColor="#D32F2F"
                      FontSize="14"
                      VerticalOptions="Center"
                      HorizontalOptions="FillAndExpand"/>
                <Button Text="Retry" 
                       Command="{Binding RetryLastCommandCommand}"
                       BackgroundColor="#D32F2F" TextColor="White"
                       FontSize="12" Padding="10,5"/>
            </StackLayout>
        </Grid>
    </Grid>
</ContentPage>